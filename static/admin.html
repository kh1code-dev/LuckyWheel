<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Duy·ªát M√£</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f2f5; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
        .btn-reset { background: #d9534f; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        
        .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .name { font-weight: bold; font-size: 1.1em; }
        .code-display { font-size: 1.5em; font-weight: bold; color: #d9534f; background: #ffe6e6; padding: 5px 15px; border: 2px dashed #d9534f; border-radius: 5px; }
        
        /* Style cho 2 khu v·ª±c */
        .section-title { font-size: 18px; margin-top: 20px; padding-bottom: 10px; border-bottom: 2px solid #ccc; }
        .approved-zone { border-left: 5px solid #28a745; background: #e8f5e9; } /* Xanh l√° */
        .pending-zone { border-left: 5px solid #ff9800; background: #fff3e0; }  /* Cam */
    </style>
</head>
<body>
    <div class="header-row">
        <h1>üëÆ Qu·∫£n L√Ω Kh√°ch H√†ng</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn-reset" onclick="resetDB()">üóëÔ∏è X√≥a Kh√°ch H√†ng</button>
            
            <button class="btn-reset" style="background: #ff9800;" onclick="resetHistory()">üìú X√≥a L·ªãch S·ª≠</button>
        </div>
    </div>
    <h3 class="section-title" style="color: #28a745;">üé´ M√É C√ì HI·ªÜU L·ª∞C (ƒê·ªçc cho kh√°ch)</h3>
    <div id="approved-list"></div>

    <h3 class="section-title" style="color: #ff9800;">‚è≥ ƒêANG CH·ªú DUY·ªÜT</h3>
    <div id="list"></div>

    <script>
        const API_URL = "http://localhost:8080/api";

        async function loadData() {
            // 1. T·∫£i danh s√°ch ƒê√£ Duy·ªát
            let resApp = await fetch(API_URL + "/admin/approved");
            let jsonApp = await resApp.json();
            const appDiv = document.getElementById('approved-list');
            appDiv.innerHTML = "";
            
            if (jsonApp.data && jsonApp.data.length > 0) {
                jsonApp.data.forEach(user => {
                    appDiv.innerHTML += `
                        <div class="card approved-zone">
                            <div>
                                <div class="name">${user.name}</div>
                                <small style="color:gray">ƒê√£ duy·ªát l√∫c ${new Date(user.created_at).toLocaleTimeString()}</small>
                            </div>
                            <span class="code-display">${user.code}</span>
                        </div>`;
                });
            } else {
                appDiv.innerHTML = "<p style='color:#999; font-style:italic'>Ch∆∞a c√≥ m√£ n√†o ƒëang ho·∫°t ƒë·ªông...</p>";
            }

            // 2. T·∫£i danh s√°ch ƒêang Ch·ªù
            let resPen = await fetch(API_URL + "/admin/pending");
            let jsonPen = await resPen.json();
            const penDiv = document.getElementById('list');
            penDiv.innerHTML = "";

            if (jsonPen.data && jsonPen.data.length > 0) {
                jsonPen.data.forEach(user => {
                    penDiv.innerHTML += `
                        <div class="card pending-zone">
                            <div>
                                <div class="name">${user.name}</div>
                                <small>üïí Ch·ªù t·ª´ ${new Date(user.create_at || user.created_at).toLocaleTimeString()}</small>
                            </div>
                            <div style="display:flex; gap:10px">
                                <button onclick="deleteUser('${user.code}')" style="background:#ddd; border:none; padding:8px; cursor:pointer; border-radius:4px">‚ùå X√≥a</button>
                                <button onclick="approve('${user.code}', '${user.name}')" style="background:#28a745; color:white; border:none; padding:8px 20px; border-radius:4px; font-weight:bold; cursor:pointer;">DUY·ªÜT ‚úÖ</button>
                            </div>
                        </div>`;
                });
            } else {
                penDiv.innerHTML = "<p style='color:#999; font-style:italic'>Kh√¥ng c√≥ ai ƒëang ch·ªù...</p>";
            }
        }

        async function approve(code, name) {
            await fetch(API_URL + "/admin/approve", {
                method: 'POST', body: JSON.stringify({ code: code })
            });
            loadData(); // T·∫£i l·∫°i ngay l·∫≠p t·ª©c
        }

        async function deleteUser(code) {
            if(!confirm("X√≥a kh√°ch n√†y?")) return;
            await fetch(API_URL + "/admin/delete", {
                method: 'POST', body: JSON.stringify({ code: code })
            });
            loadData();
        }

        async function resetDB() {
            if(!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n mu·ªën x√≥a s·∫°ch danh s√°ch kh√°ch h√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu m·ªõi?")) return;
            await fetch(API_URL + "/admin/reset", { method: 'POST' });
            loadData();
        }
        // ... (c√°c h√†m c≈© gi·ªØ nguy√™n)

        async function resetHistory() {
            if(!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫°ch L·ªäCH S·ª¨ tr√∫ng th∆∞·ªüng?")) return;
            
            try {
                let res = await fetch(API_URL + "/admin/reset-history", { method: 'POST' });
                let data = await res.json();
                
                if (data.success) {
                    alert(data.message);
                    // Kh√¥ng c·∫ßn reload trang v√¨ l·ªãch s·ª≠ hi·ªÉn th·ªã b√™n trang index.html
                } else {
                    alert("L·ªói: " + data.error);
                }
            } catch (e) {
                alert("L·ªói k·∫øt n·ªëi server");
            }
        }
        // T·ª± ƒë·ªông t·∫£i l·∫°i m·ªói 2 gi√¢y
        setInterval(loadData, 2000);
        loadData();
    </script>
</body>
</html>